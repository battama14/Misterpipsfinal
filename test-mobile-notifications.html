<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Notifications Mobile</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #0a0a0a;
            color: white;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-button {
            background: linear-gradient(135deg, #00d4ff, #5b86e5);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            font-weight: 600;
            width: 100%;
            max-width: 300px;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.3);
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4caf50;
            color: #4caf50;
        }
        .status.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            color: #f44336;
        }
        .status.warning {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #ffc107;
            color: #ffc107;
        }
        .problem-item {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid #ff6b6b;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .problem-title {
            color: #ff6b6b;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .solution {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }
        .solution-title {
            color: #4caf50;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .badge-demo {
            position: relative;
            display: inline-block;
            background: #333;
            padding: 10px 20px;
            border-radius: 25px;
            margin: 10px;
        }
        .badge-demo .nav-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff3b30;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üîî Test Notifications Mobile</h1>
    
    <div class="test-section">
        <h2>üìã Probl√®mes Identifi√©s</h2>
        
        <div class="problem-item">
            <div class="problem-title">‚ùå Probl√®me 1: Badge ne se remet pas √† z√©ro</div>
            <p>L'ic√¥ne affiche le nombre de messages re√ßus mais ne se remet pas √† z√©ro quand on lit les messages.</p>
            <div class="solution">
                <div class="solution-title">‚úÖ Solution Appliqu√©e:</div>
                <p>Observer les changements de section + reset automatique quand on va sur le chat</p>
            </div>
        </div>
        
        <div class="problem-item">
            <div class="problem-title">‚ùå Probl√®me 2: Banni√®res ne s'affichent pas toujours</div>
            <p>Les notifications push ne s'affichent pas de mani√®re fiable.</p>
            <div class="solution">
                <div class="solution-title">‚úÖ Solution Appliqu√©e:</div>
                <p>Syst√®me de banni√®res robuste avec gestion d'erreurs et fallback</p>
            </div>
        </div>
        
        <div class="problem-item">
            <div class="problem-title">‚ùå Probl√®me 3: Pas de son de notification</div>
            <p>Les notifications n'√©mettent pas de son.</p>
            <div class="solution">
                <div class="solution-title">‚úÖ Solution Appliqu√©e:</div>
                <p>Syst√®me audio am√©lior√© avec contexte audio r√©utilisable et fallback</p>
            </div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>üß™ Tests des Notifications</h2>
        <div id="notificationsStatus"></div>
        <button class="test-button" onclick="runAllNotificationTests()">üîç Tester Toutes les Notifications</button>
    </div>
    
    <div class="test-section">
        <h2>üîî Test Badge</h2>
        <div id="badgeStatus"></div>
        <div class="badge-demo" id="badgeDemo">
            üí¨ Chat
            <div class="nav-badge" id="demoBadge">3</div>
        </div>
        <button class="test-button" onclick="testBadgeIncrement()">‚ûï Incr√©menter Badge</button>
        <button class="test-button" onclick="testBadgeReset()">üîÑ Reset Badge</button>
    </div>
    
    <div class="test-section">
        <h2>üîä Test Sons</h2>
        <div id="soundStatus"></div>
        <button class="test-button" onclick="testNotificationSound()">üîä Test Son</button>
        <button class="test-button" onclick="testVibration()">üì≥ Test Vibration</button>
    </div>
    
    <div class="test-section">
        <h2>üì¢ Test Banni√®res</h2>
        <div id="bannerStatus"></div>
        <button class="test-button" onclick="requestPermissions()">üîì Demander Permissions</button>
        <button class="test-button" onclick="testNotificationBanner()">üì¢ Test Banni√®re</button>
    </div>
    
    <div class="test-section">
        <h2>üîÑ Actions Rapides</h2>
        <button class="test-button" onclick="fixAllNotifications()">üîß Corriger Tout</button>
        <button class="test-button" onclick="goToMobileDashboard()">üì± Dashboard Mobile</button>
        <button class="test-button" onclick="clearAllBadges()">üóëÔ∏è Effacer Badges</button>
    </div>
    
    <script>
        let testBadgeCount = 0;
        
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div class="status ${type}">${message}</div>`;
            }
        }
        
        function runAllNotificationTests() {
            console.log('üß™ Test complet notifications...');
            
            testBadgeSystem();
            setTimeout(() => testSoundSystem(), 1000);
            setTimeout(() => testBannerSystem(), 2000);
            
            setTimeout(() => {
                showStatus('notificationsStatus', 'Tests termin√©s - Voir les r√©sultats ci-dessous', 'success');
            }, 3000);
        }
        
        function testBadgeSystem() {
            console.log('üîî Test syst√®me badge...');
            
            const hasCorrector = !!window.mobileNotificationsCompleteFix;
            const hasResetFunction = typeof window.resetUnreadCount === 'function';
            const hasBadgeFunction = typeof window.resetMobileBadge === 'function';
            
            let status = '<h3>√âtat Syst√®me Badge:</h3>';
            status += `<p>${hasCorrector ? '‚úÖ' : '‚ùå'} Script correcteur: ${hasCorrector ? 'CHARG√â' : 'MANQUANT'}</p>`;
            status += `<p>${hasResetFunction ? '‚úÖ' : '‚ùå'} Fonction resetUnreadCount: ${hasResetFunction ? 'DISPONIBLE' : 'MANQUANTE'}</p>`;
            status += `<p>${hasBadgeFunction ? '‚úÖ' : '‚ùå'} Fonction resetMobileBadge: ${hasBadgeFunction ? 'DISPONIBLE' : 'MANQUANTE'}</p>`;
            
            // Test PWA badge
            const hasPWABadge = 'setAppBadge' in navigator;
            status += `<p>${hasPWABadge ? '‚úÖ' : '‚ùå'} Badge PWA: ${hasPWABadge ? 'SUPPORT√â' : 'NON SUPPORT√â'}</p>`;
            
            const allGood = hasCorrector && (hasResetFunction || hasBadgeFunction);
            showStatus('badgeStatus', status, allGood ? 'success' : 'error');
            
            console.log(allGood ? '‚úÖ Syst√®me badge: OK' : '‚ùå Syst√®me badge: PROBL√àME');
        }
        
        function testSoundSystem() {
            console.log('üîä Test syst√®me son...');
            
            const hasAudioContext = !!(window.AudioContext || window.webkitAudioContext);
            const hasCorrector = !!window.mobileNotificationsCompleteFix;
            
            let status = '<h3>√âtat Syst√®me Son:</h3>';
            status += `<p>${hasAudioContext ? '‚úÖ' : '‚ùå'} AudioContext: ${hasAudioContext ? 'SUPPORT√â' : 'NON SUPPORT√â'}</p>`;
            status += `<p>${hasCorrector ? '‚úÖ' : '‚ùå'} Script correcteur: ${hasCorrector ? 'CHARG√â' : 'MANQUANT'}</p>`;
            
            // V√©rifier les param√®tres
            try {
                const settings = JSON.parse(localStorage.getItem('mobileNotificationSettings')) || {};
                status += `<p>‚öôÔ∏è Son activ√©: ${settings.sound ? 'OUI' : 'NON'}</p>`;
            } catch (e) {
                status += '<p>‚ö†Ô∏è Param√®tres son: NON CONFIGUR√âS</p>';
            }
            
            const allGood = hasAudioContext && hasCorrector;
            showStatus('soundStatus', status, allGood ? 'success' : 'warning');
            
            console.log(allGood ? '‚úÖ Syst√®me son: OK' : '‚ö†Ô∏è Syst√®me son: √Ä V√âRIFIER');
        }
        
        function testBannerSystem() {
            console.log('üì¢ Test syst√®me banni√®res...');
            
            const hasNotifications = 'Notification' in window;
            const permission = hasNotifications ? Notification.permission : 'unsupported';
            const hasCorrector = !!window.mobileNotificationsCompleteFix;
            
            let status = '<h3>√âtat Syst√®me Banni√®res:</h3>';
            status += `<p>${hasNotifications ? '‚úÖ' : '‚ùå'} Support navigateur: ${hasNotifications ? 'SUPPORT√â' : 'NON SUPPORT√â'}</p>`;
            status += `<p>üîî Permission: ${permission}</p>`;
            status += `<p>${hasCorrector ? '‚úÖ' : '‚ùå'} Script correcteur: ${hasCorrector ? 'CHARG√â' : 'MANQUANT'}</p>`;
            
            // V√©rifier les param√®tres
            try {
                const settings = JSON.parse(localStorage.getItem('mobileNotificationSettings')) || {};
                status += `<p>‚öôÔ∏è Push activ√©: ${settings.push ? 'OUI' : 'NON'}</p>`;
                status += `<p>‚öôÔ∏è Vibration activ√©e: ${settings.vibrate ? 'OUI' : 'NON'}</p>`;
            } catch (e) {
                status += '<p>‚ö†Ô∏è Param√®tres push: NON CONFIGUR√âS</p>';
            }
            
            const allGood = hasNotifications && hasCorrector && permission === 'granted';
            showStatus('bannerStatus', status, allGood ? 'success' : 'warning');
            
            console.log(allGood ? '‚úÖ Syst√®me banni√®res: OK' : '‚ö†Ô∏è Syst√®me banni√®res: PERMISSIONS REQUISES');
        }
        
        function testBadgeIncrement() {
            console.log('‚ûï Test incr√©mentation badge...');
            
            testBadgeCount++;
            
            // Test badge d√©mo
            const demoBadge = document.getElementById('demoBadge');
            if (demoBadge) {
                demoBadge.textContent = testBadgeCount;
            }
            
            // Test badge PWA
            if ('setAppBadge' in navigator) {
                navigator.setAppBadge(testBadgeCount);
                console.log('‚úÖ Badge PWA mis √† jour:', testBadgeCount);
            }
            
            // Test via correcteur
            if (window.mobileNotificationsCompleteFix) {
                window.mobileNotificationsCompleteFix.incrementBadge();
                console.log('‚úÖ Badge via correcteur incr√©ment√©');
            }
        }
        
        function testBadgeReset() {
            console.log('üîÑ Test reset badge...');
            
            testBadgeCount = 0;
            
            // Reset badge d√©mo
            const demoBadge = document.getElementById('demoBadge');
            if (demoBadge) {
                demoBadge.textContent = '0';
                setTimeout(() => {
                    demoBadge.style.display = 'none';
                }, 1000);
                setTimeout(() => {
                    demoBadge.style.display = 'flex';
                }, 2000);
            }
            
            // Reset badge PWA
            if ('clearAppBadge' in navigator) {
                navigator.clearAppBadge();
                console.log('‚úÖ Badge PWA reset');
            }
            
            // Reset via correcteur
            if (window.resetUnreadCount) {
                window.resetUnreadCount();
                console.log('‚úÖ Badge via resetUnreadCount reset');
            } else if (window.resetMobileBadge) {
                window.resetMobileBadge();
                console.log('‚úÖ Badge via resetMobileBadge reset');
            }
        }
        
        function testNotificationSound() {
            console.log('üîä Test son notification...');
            
            if (window.mobileNotificationsCompleteFix && window.mobileNotificationsCompleteFix.playSound) {
                window.mobileNotificationsCompleteFix.playSound();
                console.log('‚úÖ Son via correcteur jou√©');
            } else {
                // Fallback
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);

                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);

                    console.log('‚úÖ Son fallback jou√©');
                } catch (error) {
                    console.log('‚ùå Erreur son:', error);
                    alert('‚ùå Impossible de jouer le son');
                }
            }
        }
        
        function testVibration() {
            console.log('üì≥ Test vibration...');
            
            if ('vibrate' in navigator) {
                navigator.vibrate([300, 100, 300]);
                console.log('‚úÖ Vibration test√©e');
            } else {
                console.log('‚ùå Vibration non support√©e');
                alert('‚ùå Vibration non support√©e sur cet appareil');
            }
        }
        
        async function requestPermissions() {
            console.log('üîì Demande permissions...');
            
            if (!('Notification' in window)) {
                alert('‚ùå Notifications non support√©es');
                return;
            }
            
            try {
                const permission = await Notification.requestPermission();
                console.log('üîî Permission:', permission);
                
                if (permission === 'granted') {
                    alert('‚úÖ Permissions accord√©es !');
                    setTimeout(() => testBannerSystem(), 500);
                } else {
                    alert('‚ùå Permissions refus√©es');
                }
            } catch (error) {
                console.error('Erreur permissions:', error);
                alert('‚ùå Erreur: ' + error.message);
            }
        }
        
        function testNotificationBanner() {
            console.log('üì¢ Test banni√®re notification...');
            
            if (Notification.permission !== 'granted') {
                alert('‚ùå Permissions requises - Cliquez "Demander Permissions" d\'abord');
                return;
            }
            
            try {
                const testNotif = new Notification('üß™ Test Notification', {
                    body: 'Ceci est un test de banni√®re de notification mobile',
                    icon: './Misterpips.jpg',
                    badge: './Misterpips.jpg',
                    tag: 'test-notification',
                    requireInteraction: false,
                    silent: false
                });
                
                // Son de test
                testNotificationSound();
                
                // Vibration de test
                if ('vibrate' in navigator) {
                    navigator.vibrate([200, 100, 200]);
                }
                
                testNotif.onclick = () => {
                    console.log('üîî Clic test notification');
                    testNotif.close();
                };
                
                setTimeout(() => {
                    try {
                        testNotif.close();
                    } catch (e) {}
                }, 5000);
                
                console.log('‚úÖ Banni√®re test affich√©e');
                
            } catch (error) {
                console.error('‚ùå Erreur banni√®re test:', error);
                alert('‚ùå Erreur: ' + error.message);
            }
        }
        
        function fixAllNotifications() {
            console.log('üîß Correction compl√®te notifications...');
            
            if (window.mobileNotificationsCompleteFix) {
                window.mobileNotificationsCompleteFix.fixNotifications();
                console.log('‚úÖ Corrections appliqu√©es');
                
                setTimeout(() => {
                    runAllNotificationTests();
                }, 1000);
            } else {
                alert('‚ùå Script correcteur non charg√©');
            }
        }
        
        function goToMobileDashboard() {
            console.log('üì± Redirection dashboard mobile...');
            window.location.href = 'mobile-dashboard.html';
        }
        
        function clearAllBadges() {
            console.log('üóëÔ∏è Effacement tous badges...');
            
            testBadgeCount = 0;
            
            // Badge d√©mo
            const demoBadge = document.getElementById('demoBadge');
            if (demoBadge) {
                demoBadge.textContent = '0';
            }
            
            // Badge PWA
            if ('clearAppBadge' in navigator) {
                navigator.clearAppBadge();
            }
            
            // Via correcteur
            if (window.resetUnreadCount) {
                window.resetUnreadCount();
            }
            
            console.log('‚úÖ Tous badges effac√©s');
        }
        
        // Test automatique au chargement
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('üöÄ Test automatique notifications...');
                runAllNotificationTests();
            }, 2000);
        });
        
        // V√©rifier p√©riodiquement le correcteur
        let checkInterval = setInterval(() => {
            if (window.mobileNotificationsCompleteFix) {
                console.log('‚úÖ Correcteur notifications d√©tect√©');
                clearInterval(checkInterval);
                
                setTimeout(() => {
                    runAllNotificationTests();
                }, 500);
            }
        }, 1000);
        
        setTimeout(() => {
            clearInterval(checkInterval);
        }, 10000);
    </script>
</body>
</html>